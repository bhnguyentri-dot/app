<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L·ªãch C√¥ng T√°c BHS - V9.4 UI UPDATE</title>
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#3a60a6">
    <link rel="apple-touch-icon" href="https://drive.google.com/uc?export=download&id=16GLGOJ6r9kM9qEtkCdTiRpvDNDUksuQI">
    
    <style>
        /* --- CSS BASE --- */
        body { margin: 0; padding: 0; background-color: #f4f6f9; scroll-behavior: smooth; }
        #schedule-container { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 20px auto; width: 98%; max-width: 1400px; box-sizing: border-box; color: #333; background: white; padding: 20px; box-shadow: 0 4px 25px rgba(0,0,0,0.08); border-radius: 12px; }
        
        /* HEADER & DASHBOARD NEW STYLE */
        .schedule-header h2 { text-align: center; color: #1a237e; margin: 0 0 15px 0; text-transform: uppercase; font-size: 24px; font-weight: 800; letter-spacing: 0.5px; }
        
        /* Dashboard d·∫°ng Pills nh∆∞ ·∫£nh */
        .dashboard-panel { display: flex; justify-content: center; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; display: none; }
        .stat-pill { 
            background: white; padding: 8px 24px; border-radius: 25px; 
            border: 1px solid #e0e0e0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
            font-size: 14px; font-weight: 700; color: #444; 
            display: flex; align-items: center;
        }
        .stat-count-red { color: #d32f2f; font-size: 1.2em; margin-left: 6px; font-weight: 800; }
        .stat-date-green { color: #198754; font-size: 1.2em; margin-left: 6px; font-weight: 800; }
        
        /* TABLE STYLES */
        .table-responsive { overflow: auto; max-height: 75vh; border: 1px solid #e0e0e0; border-radius: 8px; position: relative; display: none; scrollbar-width: thin; }
        table.custom-schedule { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 1000px; font-size: 14.5px; background-color: white; }
        
        /* --- HEADER CHU·∫®N M√ÄU M·ªöI (Xanh ƒë·∫≠m ph·∫≥ng) --- */
        table.custom-schedule thead th { 
            background-color: #3a60a6; /* M√†u m·ªõi gi·ªëng ·∫£nh */
            color: #ffffff !important; 
            padding: 15px 10px; 
            text-align: center; 
            border-right: 1px solid rgba(255,255,255,0.1); 
            white-space: nowrap; 
            font-weight: 800; 
            text-transform: uppercase; 
            position: sticky; 
            top: 0; 
            z-index: 30; 
            vertical-align: middle;
            font-size: 13.5px; /* ƒêi·ªÅu ch·ªânh size ch·ªØ header nh·ªè l·∫°i ch√∫t cho g·ªçn */
        }
        
        table.custom-schedule td { border-bottom: 1px solid #e0e0e0; border-right: 1px solid #e0e0e0; padding: 12px 14px; vertical-align: middle; color: #333; line-height: 1.6; }

        /* --- CLASS ·∫®N C·ªòT ƒê·∫¶U TI√äN (INDEX 0) --- */
        .col-hidden { display: none !important; }

        /* --- CLASS C·ªòT TH·ª® R·ªòNG (120px) --- */
        .col-wide-thu {
            min-width: 120px !important;
            width: 120px !important;
            text-align: center;
        }
        /* Style ri√™ng cho n·ªôi dung c·ªôt Th·ª© (M√†u xanh, ƒë·∫≠m) */
        td.col-wide-thu {
            color: #1565c0 !important;
            font-weight: 700 !important;
        }
        /* Style ri√™ng cho Header c·ªôt Th·ª© (M√†u tr·∫Øng) */
        th.col-wide-thu {
            color: #ffffff !important;
        }

        /* C·ªôt Ng√†y (C·ªôt th·ª© 2 -> Gi·ªù th√†nh c·ªôt ƒë·∫ßu ti√™n hi·ªÉn th·ªã) */
        table.custom-schedule td.col-sticky-date { 
            background-color: #f0f7ff; 
            font-weight: 700; 
            text-align: center; 
            color: #1565c0; 
            position: sticky; 
            left: 0; 
            z-index: 10; 
            border-right: 2px solid #b0bec5; 
        }

        /* C·ªôt Th·ªùi gian */
        table.custom-schedule td.col-time { 
            font-weight: 700; 
            text-align: center; 
            white-space: nowrap; 
            color: #c62828; 
            background-color: #fff8f8; 
        }

        /* --- MOBILE LOGIC --- */
        @media screen and (max-width: 768px) {
            /* 1. B·ªè c·ªë ƒë·ªãnh c·ªôt Ng√†y tr√™n ƒëi·ªán tho·∫°i */
            table.custom-schedule td.col-sticky-date, 
            table.custom-schedule th.col-sticky-date {
                position: static !important;
                z-index: 1 !important;
                border-right: 1px solid #e0e0e0 !important;
            }
            
            /* 2. C·ªë ƒë·ªãnh c·ªôt Th·ªùi Gian tr√™n ƒëi·ªán tho·∫°i */
            table.custom-schedule td.col-time,
            table.custom-schedule th.col-time {
                position: sticky !important;
                left: 0 !important;
                z-index: 25 !important;
                border-right: 2px solid #888 !important;
                box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            }
            table.custom-schedule thead th.col-time { z-index: 35 !important; background-color: #3a60a6 !important; }
            table.custom-schedule td.col-time { background-color: #fff8f8; }
            
            /* M√†u c·ªôt th·ªùi gian sticky khi l√† Today */
            tr.is-today td.col-time {
                background-color: #8fd19e !important;
                color: #000 !important;
                border-right: 2px solid #0f5132 !important;
            }
        }

        /* --- FULL GREEN BLOCK FOR TODAY --- */
        tr.is-today td { 
            background-color: #c3e6cb !important; 
            color: #000 !important;
            border-bottom: 1px solid #8fd19e !important; 
        }
        tr.is-today td.col-sticky-date {
            background-color: #8fd19e !important; 
            color: #064420 !important;
            border-right: 2px solid #0f5132 !important; 
        }
        /* C·ªôt Th·ª© c≈©ng ƒë·ªïi m√†u xanh ƒë·∫≠m khi l√† Today */
        tr.is-today td.col-wide-thu {
            color: #064420 !important;
        }

        @media screen and (max-width: 768px) {
            tr.is-today td.col-sticky-date { border-right: 1px solid #0f5132 !important; }
        }

        table.custom-schedule tbody tr:hover td:not(.col-sticky-date) { background-color: #fffce7; cursor: default; }
        
        /* UTILS */
        .filter-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; display: none; }
        .filter-btn { padding: 8px 20px; border: 1px solid #ddd; background: white; border-radius: 25px; cursor: pointer; font-size: 14px; font-weight: 600; color: #555; transition: all 0.2s; }
        .filter-btn:hover { background-color: #f0f0f0; }
        .filter-btn.active { background: #3a60a6; color: white; border-color: #3a60a6; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        
        #loading-state { text-align: center; padding: 50px; color: #3a60a6; display: block; }
        .spinner { border: 4px solid rgba(58, 96, 166, 0.1); border-top: 4px solid #3a60a6; border-radius: 50%; width: 50px; height: 50px; animation: spin 0.8s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .search-wrapper { display: flex; justify-content: space-between; margin-bottom: 15px; gap: 12px; display: none; }
        #searchInput { flex-grow: 1; padding: 10px 20px; border: 2px solid #e0e0e0; border-radius: 25px; font-size: 15px; outline: none; }
        #searchInput:focus { border-color: #3a60a6; }
        .btn-print { background-color: #555; color: white; border: none; padding: 0 25px; border-radius: 25px; cursor: pointer; font-weight: bold; }
        
        #install-app-btn { display: none; background: #3a60a6; color: white; border: none; padding: 10px 24px; border-radius: 30px; cursor: pointer; font-weight: bold; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(58, 96, 166, 0.3); }

        /* TAG BGH */
        .tag-bgh { 
            background-color: #FFC000; color: #000; padding: 3px 8px; border-radius: 4px; font-weight: 800; display: inline-block; font-size: 13px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        #toast-notify { visibility: hidden; min-width: 300px; background: #198754; color: #fff; text-align: center; border-radius: 50px; padding: 12px; position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 99999; font-size: 15px; opacity: 0; transition: opacity 0.5s; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        #toast-notify.show { visibility: visible; opacity: 1; }
        
        @media print { .search-wrapper, #ai-dashboard, .filter-tabs, .btn-print, #toast-notify, #install-app-btn { display: none !important; } .table-responsive { overflow: visible; max-height: none; border: none; display: block !important; } #schedule-container { box-shadow: none; padding: 0; } }
    </style>
</head>
<body>

<div id="schedule-container">
    <div style="text-align: center;">
        <button id="install-app-btn">üì≤ C√†i ƒë·∫∑t App BHS</button>
    </div>
    <div id="top-info" class="schedule-header"></div>
    <div id="ai-dashboard" class="dashboard-panel"></div>
    <div id="day-filters" class="filter-tabs"></div>
    <div id="loading-state"><div class="spinner"></div><span id="loading-text" style="font-weight: 600;">ƒêang t·∫£i d·ªØ li·ªáu...</span></div>
    
    <div id="search-area" class="search-wrapper">
        <input type="text" id="searchInput" placeholder="üîç T√¨m ki·∫øm (v√≠ d·ª•: Th·ª© 5, BGH, 04/12)...">
        <button onclick="window.print()" class="btn-print">In L·ªãch</button>
    </div>
    
    <div id="main-table" class="table-responsive"></div>
</div>
<div id="toast-notify">üîî D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t!</div>

<script>
/**
 * APP BHS SCHEDULER - V9.4 UI UPDATE
 * - C·∫≠p nh·∫≠t giao di·ªán Dashboard (Pills).
 * - C·∫≠p nh·∫≠t m√†u s·∫Øc Header b·∫£ng (Flat Blue).
 * - Hardcode t√™n c·ªôt theo y√™u c·∫ßu h√¨nh ·∫£nh.
 */

const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbysvLenfsJak8UG4UHJfqBG1Kao-VFHVQgJ3MlK6V4VvZi0hGP6wMNEGs0Gk7DOJMiDig/exec'; 

const FALLBACK_DATA = `L·ªäCH C√îNG T√ÅC TU·∫¶N (OFFLINE)\nTh·ª©,Ng√†y,Th·ªùi gian,N·ªôi dung,ƒê·ªãa ƒëi·ªÉm,Ch·ªß tr√¨,Th√†nh ph·∫ßn,Ghi ch√∫,Kh·ªëi\nHai,01/01,07:00,Ch√†o c·ªù ƒë·∫ßu tu·∫ßn,S√¢n tr∆∞·ªùng,BGH,To√†n tr∆∞·ªùng,,THCS`;

const TAG_COLOR_MAP = { "BGH": "tag-bgh" };
const TAG_REGEX = new RegExp(`\\b(${Object.keys(TAG_COLOR_MAP).join('|')})\\b`, 'g');

// --- M·∫¢NG T√äN HEADER M·ªöI D·ª∞A TR√äN ·∫¢NH ---
// L∆∞u √Ω: Th·ª© t·ª± n√†y s·∫Ω √°p d·ª•ng l√™n d·ªØ li·ªáu t·ª´ Sheet. 
// C·ªôt ƒë·∫ßu ti√™n trong m·∫£ng n√†y s·∫Ω √°p d·ª•ng cho c·ªôt index 0 (·∫©n), c·ªôt th·ª© 2 cho index 1 (Ng√†y), v.v.
// D·ª±a tr√™n ·∫£nh: C·ªôt "NG√ÄY / TH·ª®" l√† c·ªôt ƒë·∫ßu ti√™n hi·ªÉn th·ªã.
const NEW_DISPLAY_HEADERS = [
    "", // Index 0 (·∫®n) - Gi·ªØ tr·ªëng ho·∫∑c t√™n g·ªëc
    "NG√ÄY / TH·ª®", // Index 1 (C·ªôt Ng√†y c≈© -> Gi·ªù l√† Ng√†y/Th·ª©)
    "TH·ªúI GIAN", // Index 2
    "N·ªòI DUNG CH√çNH", // Index 3
    "N·ªòI DUNG CHI TI·∫æT", // Index 4 (Ch·ªß tr√¨ c≈© -> C√≥ v·∫ª c·∫•u tr√∫c Sheet ƒë√£ thay ƒë·ªïi?)
    "CH·ª¶ TR√å", // Index 5
    "TH√ÄNH PH·∫¶N", // Index 6
    "ƒê·ªäA ƒêI·ªÇM", // Index 7
    "GHI CH√ö", // Index 8
    "BGH-KH·ªêI QU·∫¢N L√ù-VƒÇN PH√íNG" // Index 9
];


const App = {
    currentFilterDay: 'all',
    CACHE_KEY: 'instant_schedule_data_v9',
    HASH_KEY: 'instant_schedule_hash_v9',
    deferredPrompt: null,

    init() {
        document.addEventListener('DOMContentLoaded', () => {
            this.registerServiceWorker();
            this.loadFromCache();
            this.loadScheduleData(false);
            this.initRealtimeCheck(); 
            this.setupInstallButton();
        });
    },

    registerServiceWorker() {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').catch(err => console.log(err));
        }
    },

    setupInstallButton() {
        const installBtn = document.getElementById('install-app-btn');
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            this.deferredPrompt = e;
            installBtn.style.display = 'inline-block';
        });
        installBtn.addEventListener('click', () => {
            installBtn.style.display = 'none';
            this.deferredPrompt.prompt();
            this.deferredPrompt.userChoice.then((res) => { this.deferredPrompt = null; });
        });
    },

    setupEventListeners() {
        const searchInput = document.getElementById('searchInput');
        if(searchInput) searchInput.addEventListener('keyup', () => setTimeout(() => this.filterTable(), 300));
    },

    parseCSV(text) {
        const rows = []; let currentRow = []; let currentVal = ''; let inQuote = false;
        for (let i = 0; i < text.length; i++) {
            const char = text[i], nextChar = text[i + 1];
            if (char === '"') { inQuote ? (nextChar === '"' ? (currentVal += '"', i++) : inQuote = !inQuote) : inQuote = !inQuote; } 
            else if (char === ',' && !inQuote) { currentRow.push(currentVal); currentVal = ''; } 
            else if ((char === '\r' || char === '\n') && !inQuote) { if (char === '\r' && nextChar === '\n') i++; currentRow.push(currentVal); rows.push(currentRow); currentRow = []; currentVal = ''; } else { currentVal += char; }
        }
        if (currentRow.length > 0 || currentVal !== '') { currentRow.push(currentVal); rows.push(currentRow); }
        return rows;
    },

    filterTable() {
        const input = document.getElementById("searchInput");
        // --- AI UPGRADE: T√åM KI·∫æM TH√îNG MINH (B·∫•t ch·∫•p d·∫•u Ti·∫øng Vi·ªát) ---
        const rawKeyword = input.value;
        const removeAccents = (str) => { return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/ƒë/g, "d").replace(/ƒê/g, "D"); };
        const textFilter = removeAccents(rawKeyword).toUpperCase();
        
        const table = document.querySelector("table.custom-schedule");
        if (!table) return;
        
        const rows = table.querySelector("tbody").getElementsByTagName("tr");
        for (const row of rows) {
            if (row.classList.contains('no-results-row')) continue;
            const rowDay = row.getAttribute('data-day');
            const rowHiddenDay = rowDay ? rowDay.toUpperCase() : '';
            const rowHiddenDate = row.getAttribute('data-date') ? row.getAttribute('data-date').toUpperCase() : '';
            const rowVisibleText = row.textContent.toUpperCase();
            const fullContentNoAccent = removeAccents(rowVisibleText + " " + rowHiddenDay + " " + rowHiddenDate);

            const dayMatch = (this.currentFilterDay === 'all') || (rowDay === this.currentFilterDay);
            const searchMatch = textFilter === "" || fullContentNoAccent.includes(textFilter);
            
            row.style.display = (dayMatch && searchMatch) ? "" : "none";
        }
    },

    setDayFilter(day, btnElement) {
        this.currentFilterDay = day;
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        if(btnElement) btnElement.classList.add('active');
        const searchInput = document.getElementById('searchInput');
        if(searchInput) searchInput.value = '';
        this.filterTable();
    },

    loadFromCache() {
        const cached = localStorage.getItem(this.CACHE_KEY);
        if (cached) this.renderProfessionalTable(cached, false);
    },

    loadScheduleData(isBackground = false) {
        const noCacheUrl = SCRIPT_URL + (SCRIPT_URL.includes('?') ? '&' : '?') + 'nocache=' + new Date().getTime();
        fetch(noCacheUrl, { method: 'GET' })
            .then(res => res.text())
            .then(csv => {
                if (!csv || csv.includes("Error") || csv.length < 50) return;
                if(isBackground) { this.checkAndAutoUpdate(csv); } else { this.processNewData(csv); }
            })
            .catch(err => {
                if(!isBackground && !localStorage.getItem(this.CACHE_KEY)) this.renderProfessionalTable(FALLBACK_DATA, true);
            });
    },

    processNewData(newCsv) {
        localStorage.setItem(this.CACHE_KEY, newCsv);
        localStorage.setItem(this.HASH_KEY, newCsv.length);
        this.renderProfessionalTable(newCsv);
    },

    checkAndAutoUpdate(newCsv) {
        const oldHash = localStorage.getItem(this.HASH_KEY);
        if (oldHash && parseInt(oldHash) !== newCsv.length) {
            this.processNewData(newCsv); 
            const toast = document.getElementById("toast-notify");
            if (toast) { toast.classList.add("show"); setTimeout(() => toast.classList.remove("show"), 3000); }
            
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({ type: 'SHOW_NOTIFICATION', title: 'C·∫≠p nh·∫≠t', body: 'L·ªãch c√¥ng t√°c m·ªõi' });
            }
        }
    },

    initRealtimeCheck() { setInterval(() => { this.loadScheduleData(true); }, 15000); },

    getTodayString() {
        const today = new Date();
        const d = today.getDate();
        const m = today.getMonth() + 1;
        const format1 = `${d < 10 ? '0' + d : d}/${m < 10 ? '0' + m : m}`;
        return [format1];
    },

    renderProfessionalTable(csvText, isDemo = false) {
        try {
            const rawData = this.parseCSV(csvText);
            const headerRowIndex = rawData.findIndex(row => row.some(c => c && c.toLowerCase().includes('th·ª©'))) || 0;
            const headersOrigin = rawData[headerRowIndex]; // Header g·ªëc t·ª´ CSV
            const bodyRows = rawData.slice(headerRowIndex + 1).filter(r => !r.every(c => c.trim() === ''));
            
            if (!isDemo && headerRowIndex > 0) {
                const info = rawData[0].filter(c => c).join(' - ');
                if(info) document.getElementById('top-info').innerHTML = `<h2>${info}</h2>`;
            }

            const todayFormats = this.getTodayString(); 

            // --- RENDER DASHBOARD M·ªöI (D·∫°ng Pills) ---
            const dashboardTarget = document.getElementById('ai-dashboard');
            dashboardTarget.innerHTML = `
                <div class="stat-pill">S·ª± ki·ªán: <span class="stat-count-red">${bodyRows.length}</span></div>
                <div class="stat-pill">L·ªãch BGH: <span class="stat-count-red">${bodyRows.filter(r => r.join(' ').toUpperCase().includes('BGH')).length}</span></div>
                <div class="stat-pill">H√¥m nay: <span class="stat-date-green">${todayFormats[0]}</span></div>
            `;
            dashboardTarget.style.display = "flex";

            const spanMap = this.calculateRowSpans(bodyRows, headersOrigin);
            let bodyHtml = ''; const uniqueDays = new Set();
            // C√°c index quan tr·ªçng (d·ª±a tr√™n d·ªØ li·ªáu g·ªëc)
            const idxTime = headersOrigin.findIndex(c => c.toLowerCase().includes('th·ªùi gian'));
            const idxChuTri = headersOrigin.findIndex(c => c.toLowerCase().includes('ch·ªß tr√¨'));
            const idxThu = headersOrigin.findIndex(c => c.toLowerCase().includes('th·ª©'));
            const idxNgay = headersOrigin.findIndex(c => c.toLowerCase().includes('ng√†y')) || 1;

            let lastSeenDate = '';
            let lastSeenDay = '';

            // --- RENDER HEADER V·ªöI T√äN M·ªöI ---
            const headerHtml = headersOrigin.map((h, i) => {
                let extraClass = '';
                if (i === 0) extraClass += ' col-hidden';
                // N·∫øu c·ªôt hi·ªán t·∫°i l√† c·ªôt Ng√†y (idxNgay), √°p d·ª•ng class col-wide-thu ƒë·ªÉ r·ªông ra ch·ª©a "NG√ÄY / TH·ª®"
                if (i === idxNgay) extraClass += ' col-wide-thu'; 
                
                // S·ª≠ d·ª•ng t√™n t·ª´ m·∫£ng NEW_DISPLAY_HEADERS n·∫øu c√≥, ng∆∞·ª£c l·∫°i d√πng t√™n g·ªëc
                const headerText = NEW_DISPLAY_HEADERS[i] !== undefined ? NEW_DISPLAY_HEADERS[i] : h;

                return `<th class="${extraClass}">${headerText}</th>`;
            }).join('');

            bodyRows.forEach((row, rIdx) => {
                let dayText = (row[0] || '').trim();
                let dateText = (row[idxNgay] || '').trim();

                if (dateText) lastSeenDate = dateText;
                if (dayText) lastSeenDay = dayText;

                if(lastSeenDay && lastSeenDay.toLowerCase().includes('th·ª©')) uniqueDays.add(lastSeenDay);
                
                let isToday = false;
                if (lastSeenDate) {
                    isToday = todayFormats.some(fmt => lastSeenDate.includes(fmt));
                }
                const rowClass = isToday ? 'is-today' : '';

                bodyHtml += `<tr data-day="${lastSeenDay}" data-date="${lastSeenDate}" class="${rowClass}">`;
                
                headersOrigin.forEach((h, c) => {
                    if (spanMap[rIdx] && spanMap[rIdx][c] === 0) return;
                    let content = row[c] || '';
                    
                    if(c === idxChuTri) {
                        content = content.replace(TAG_REGEX, m => `<span class="${TAG_COLOR_MAP[m]}">${m}</span>`);
                    } else if (content === 'BGH') {
                        content = `<span class="tag-bgh">${content}</span>`;
                    }
                    
                    // Logic class cho body
                    let cls = '';
                    if (c === 0) cls += 'col-hidden';
                    // C·ªôt Ng√†y b√¢y gi·ªù ƒë√≥ng vai tr√≤ l√† c·ªôt "NG√ÄY / TH·ª®" ch√≠nh
                    if (c === idxNgay) cls += 'col-sticky-date col-wide-thu'; 
                    if (c === idxTime) cls += 'col-time';
                    
                    let rowspan = (spanMap[rIdx][c] > 1) ? ` rowspan="${spanMap[rIdx][c]}"` : '';
                    bodyHtml += `<td class="${cls}"${rowspan}>${content.replace(/\n/g, '<br>')}</td>`;
                });
                bodyHtml += `</tr>`;
            });

            document.getElementById('main-table').innerHTML = `<table class="custom-schedule"><thead><tr>${headerHtml}</tr></thead><tbody>${bodyHtml}</tbody></table>`;
            
            // S·∫Øp x·∫øp l·∫°i th·ª© t·ª± n√∫t l·ªçc
            const sortedDays = Array.from(uniqueDays).sort((a, b) => {
                const extractNum = (s) => {
                    if (s.toLowerCase().includes("hai")) return 2;
                    if (s.toLowerCase().includes("ba")) return 3;
                    if (s.toLowerCase().includes("t∆∞")) return 4;
                    if (s.toLowerCase().includes("nƒÉm")) return 5;
                    if (s.toLowerCase().includes("s√°u")) return 6;
                    if (s.toLowerCase().includes("b·∫£y")) return 7;
                    if (s.toLowerCase().includes("ch·ªß")) return 8;
                    return 99;
                };
                return extractNum(a) - extractNum(b);
            });

            let filtersHtml = `<button class="filter-btn active" onclick="App.setDayFilter('all', this)">T·∫•t c·∫£</button>`;
            sortedDays.forEach(day => { if(day.length<25) filtersHtml += `<button class="filter-btn" onclick="App.setDayFilter('${day}', this)">${day}</button>`; });
            document.getElementById('day-filters').innerHTML = filtersHtml;
            document.getElementById('day-filters').style.display = 'flex';

            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('main-table').style.display = 'block';
            document.getElementById('search-area').style.display = 'flex';
            this.setupEventListeners();
            
            setTimeout(() => {
                const todayRow = document.querySelector('tr.is-today');
                if(todayRow) todayRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 500);

        } catch (e) { console.error(e); }
    },

    calculateRowSpans(bodyRows, headers) {
        if (!bodyRows.length) return [];
        const idxTime = headers.findIndex(c => c.toLowerCase().includes('th·ªùi gian'));
        const idxNgay = headers.findIndex(c => c.toLowerCase().includes('ng√†y')) || 1;
        // Merge d·ª±a tr√™n c·ªôt 0 (·∫©n), c·ªôt Ng√†y, v√† c·ªôt Th·ªùi gian
        const colsToMerge = [0, idxNgay, idxTime].filter(i => i !== -1 && i !== undefined);
        
        const spanMap = bodyRows.map(() => Array(headers.length).fill(1));
        let start = 0;
        for (let i = 1; i < bodyRows.length; i++) {
            const match = colsToMerge.every(c => (bodyRows[i][c]||'').trim() === (bodyRows[i-1][c]||'').trim() && (bodyRows[i][c]||''));
            if (match) { colsToMerge.forEach(c => { spanMap[i][c] = 0; spanMap[start][c]++; }); } else { start = i; }
        }
        return spanMap;
    }
};

App.init();
</script>
</body>
</html>
