<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L·ªãch C√¥ng T√°c Th√¥ng Minh v7.0 - AI Super Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        /* --- CORE RESET & FONT --- */
        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
            --accent-color: #d97706;
            --bg-color: #f8fafc;
            --surface-color: #ffffff;
            --text-color: #1e293b;
            --border-radius: 12px;
        }

        body { margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-color); font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
        
        #schedule-container { 
            margin: 30px auto; width: 95%; max-width: 1600px; 
            background: var(--surface-color); padding: 30px; 
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.1); 
            border-radius: var(--border-radius); 
            border: 1px solid rgba(255,255,255,0.5);
        }
        
        /* --- HEADER --- */
        .schedule-header { text-align: center; margin-bottom: 30px; }
        .schedule-header h2 { 
            color: var(--secondary-color); margin: 0 0 8px 0; 
            text-transform: uppercase; font-size: 28px; font-weight: 800; letter-spacing: -0.5px; 
        }
        .schedule-header .sub-info { color: #64748b; font-weight: 500; font-size: 16px; }
        
        /* --- AI DASHBOARD --- */
        .dashboard-panel { display: flex; justify-content: center; gap: 20px; margin-bottom: 25px; flex-wrap: wrap; display: none; }
        .stat-card { 
            background: white; padding: 15px 25px; border-radius: var(--border-radius); 
            border: 1px solid #e2e8f0; border-left: 6px solid var(--primary-color);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); font-size: 14px; font-weight: 600; color: #475569;
            transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .stat-card span { color: var(--primary-color); font-size: 1.4em; margin-left: 8px; font-weight: 800; }
        .stat-card.highlight { border-left-color: var(--accent-color); }
        .stat-card.highlight span { color: var(--accent-color); }

        /* --- FILTERS --- */
        .filter-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 25px; flex-wrap: wrap; display: none; }
        .filter-btn {
            padding: 10px 20px; border: 1px solid #cbd5e1; background: white; border-radius: 50px;
            cursor: pointer; font-size: 14px; font-weight: 600; color: #64748b; transition: all 0.2s;
        }
        .filter-btn:hover { background: #f1f5f9; color: #334155; }
        .filter-btn.active { 
            background: var(--primary-color); color: white; border-color: var(--primary-color); 
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); transform: scale(1.05);
        }

        /* --- TOOLS --- */
        .search-wrapper { display: flex; justify-content: space-between; margin-bottom: 20px; gap: 15px; display: none; }
        #searchInput { 
            flex-grow: 1; padding: 12px 20px; border: 2px solid #e2e8f0; border-radius: var(--border-radius); 
            font-size: 15px; transition: all 0.3s; 
        }
        #searchInput:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .btn-print { 
            background-color: #334155; color: white; border: none; padding: 0 30px; 
            border-radius: var(--border-radius); cursor: pointer; font-weight: 700; 
            transition: background 0.2s; display: flex; align-items: center; gap: 8px;
        }
        .btn-print:hover { background-color: #1e293b; }

        /* --- TABLE --- */
        .table-responsive { overflow-x: auto; border: 1px solid #e2e8f0; border-radius: var(--border-radius); display: none; }
        table.custom-schedule { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 1000px; font-size: 14px; background: white; }
        
        table.custom-schedule thead th { 
            background-color: var(--primary-color); color: white; padding: 16px 12px; 
            text-align: center; border-bottom: 3px solid #1d4ed8; white-space: nowrap; 
            font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
            position: sticky; top: 0; z-index: 10; 
        }
        
        table.custom-schedule td { border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; padding: 14px 16px; vertical-align: middle; line-height: 1.6; color: #334155; }
        table.custom-schedule tr:last-child td { border-bottom: none; }

        /* Sticky Columns */
        table.custom-schedule td.col-sticky-date { 
            background-color: #f0f9ff !important; font-weight: 700; text-align: center; 
            color: var(--secondary-color); position: sticky; left: 0; z-index: 5; 
            border-right: 2px solid #cbd5e1; min-width: 120px;
        }
        
        table.custom-schedule td.col-time { font-weight: 700; text-align: center; white-space: nowrap; color: #dc2626; background-color: #fef2f2; width: 80px; }
        table.custom-schedule td.align-center { text-align: center; }

        /* Row Colors */
        tr.row-thcs td:not(.col-sticky-date) { background-color: #f0fdf4; } /* Xanh l√° nh·∫°t */
        tr.row-th td:not(.col-sticky-date) { background-color: #f8fafc; } /* Tr·∫Øng x√°m */
        table.custom-schedule tbody tr:hover td:not(.col-sticky-date) { background-color: #fffbeb !important; cursor: default; transition: background 0.1s; }

        /* Tags */
        .tag-common { padding: 4px 10px; border-radius: 6px; font-weight: 700; font-size: 0.85em; display: inline-block; margin: 3px; border: 1px solid rgba(0,0,0,0.05); }
        .tag-bgh { background-color: #fef3c7; color: #b45309; }
        .tag-tpt { background-color: #ffedd5; color: #c2410c; }
        .tag-sgd { background-color: #dbeafe; color: #1e40af; }
        
        /* Person Tags */
        .tag-name-ht { background-color: #fee2e2; color: #b91c1c; }
        .tag-name-hp { background-color: #dcfce7; color: #15803d; }
        .tag-name-tt { background-color: #e0f2fe; color: #0369a1; }
        .tag-name-gvcn { background-color: #f3e8ff; color: #7e22ce; }
        .tag-name-gv { background-color: #f1f5f9; color: #475569; }

        /* Loading */
        #loading-state { text-align: center; padding: 60px; }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { color: #dc2626; background: #fef2f2; padding: 20px; border-radius: 8px; border: 1px solid #fecaca; font-weight: 600; display: inline-block;}

        /* Print */
        @media print {
            body { background: white; -webkit-print-color-adjust: exact; }
            #schedule-container { box-shadow: none; width: 100%; margin: 0; padding: 0; border: none; max-width: none; }
            .search-wrapper, #ai-dashboard, .filter-tabs, .btn-print, #loading-state { display: none !important; }
            .table-responsive { display: block !important; overflow: visible; border: none; }
            table.custom-schedule th { background-color: #e2e8f0 !important; color: black !important; border: 1px solid #000; }
            table.custom-schedule td { border: 1px solid #000; }
        }
    </style>
</head>
<body>

<div id="schedule-container">
    <div id="top-info" class="schedule-header"></div>
    
    <div id="ai-dashboard" class="dashboard-panel"></div>

    <div id="day-filters" class="filter-tabs"></div>
    
    <div id="loading-state">
        <div class="spinner"></div> 
        <span id="loading-text" style="color: #64748b; font-weight: 600;">ƒêang k·∫øt n·ªëi AI v√† t·∫£i d·ªØ li·ªáu...</span>
    </div>

    <div id="search-area" class="search-wrapper">
        <input type="text" id="searchInput" placeholder="üîç T√¨m ki·∫øm nhanh (Gi√°o vi√™n, n·ªôi dung, ph√≤ng h·ªçp)..." onkeyup="filterTable()">
        <button onclick="window.print()" class="btn-print">üñ®Ô∏è In L·ªãch</button>
    </div>

    <div id="main-table" class="table-responsive"></div>
</div>

<script>
/**
 * AI SUPER-SCHEDULER v7.0 (Fixed & Modernized)
 */
const CONFIG = {
    sheetID: '2PACX-1vSheQFXC-BtDQtik0k6-_exzRtP2qt7sVhPOnnYsJv-aR5gDWIasN8XS8rqXrAcmopof0utvzZZHe0A',
    sheetGid: '2028559314', // GID c·ªßa Sheet L·ªäCH TU·∫¶N
    proxies: [
        'https://api.allorigins.win/raw?url=',
        'https://api.codetabs.com/v1/proxy?quest=',
        'https://corsproxy.io/?'
    ]
};

// D·ªØ li·ªáu m·∫´u d√πng khi m·∫•t k·∫øt n·ªëi
const FALLBACK_DATA = `
TU·∫¶N 20 - NƒÇM H·ªåC 2024-2025
T·ª´ ng√†y 01/01 ƒë·∫øn 07/01/2025
Th·ª©,Ng√†y,Th·ªùi gian,N·ªôi dung,ƒê·ªãa ƒëi·ªÉm,Ch·ªß tr√¨,Th√†nh ph·∫ßn,Ghi ch√∫,Kh·ªëi
Hai,01/01,07:00,Ch√†o c·ªù ƒë·∫ßu tu·∫ßn,S√¢n tr∆∞·ªùng,BGH,To√†n tr∆∞·ªùng,,THCS
Hai,01/01,08:00,H·ªçp giao ban BGH,Ph√≤ng HT,HT,BGH,,TH
Ba,02/01,14:00,T·∫≠p hu·∫•n chuy√™n m√¥n,H·ªôi tr∆∞·ªùng A,P.HT,GVCN Kh·ªëi 9,,THCS
T∆∞,03/01,08:00,D·ª± gi·ªù thƒÉm l·ªõp 5A,L·ªõp 5A,TT,GV T·ªï 5,,TH
NƒÉm,04/01,08:00,Thi HSG C·∫•p Tr∆∞·ªùng,Ph√≤ng 1-5,BGH,HS ƒê·ªôi tuy·ªÉn,,THCS
NƒÉm,04/01,14:00,H·ªçp t·ªï chuy√™n m√¥n,VƒÉn ph√≤ng,TT,GV,,TH
S√°u,05/01,07:30,Lao ƒë·ªông v·ªá sinh,Khu v·ª±c ƒë∆∞·ª£c ph√¢n c√¥ng,TPT,HS,,THCS
`;

let currentFilterDay = 'all';

// --- UTILS ---
function showError(msg) {
    const loadingEl = document.getElementById('loading-state');
    if (loadingEl) loadingEl.innerHTML = `<div class="error-msg">‚ö†Ô∏è ${msg}</div>`;
}

function escapeHtml(text) {
    if (!text) return '';
    return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
}

function parseCSV(text) {
    const rows = [];
    let currentRow = [];
    let currentVal = '';
    let inQuote = false;
    for (let i = 0; i < text.length; i++) {
        const char = text[i], nextChar = text[i + 1];
        if (char === '"') { inQuote ? (nextChar === '"' ? (currentVal += '"', i++) : inQuote = !inQuote) : inQuote = !inQuote; } 
        else if (char === ',' && !inQuote) { currentRow.push(currentVal); currentVal = ''; } 
        else if ((char === '\r' || char === '\n') && !inQuote) { 
            if (char === '\r' && nextChar === '\n') i++; 
            currentRow.push(currentVal); rows.push(currentRow); currentRow = []; currentVal = ''; 
        } else { currentVal += char; }
    }
    if (currentRow.length > 0 || currentVal !== '') { currentRow.push(currentVal); rows.push(currentRow); }
    return rows;
}

// --- LOGIC ---
function loadScheduleData() {
    const sourceUrl = `https://docs.google.com/spreadsheets/d/e/${CONFIG.sheetID}/pub?gid=${CONFIG.sheetGid}&single=true&output=csv`;
    const url1 = CONFIG.proxies[0] + encodeURIComponent(sourceUrl);
    
    fetch(url1)
        .then(res => { if (!res.ok) throw new Error(res.status); return res.text(); })
        .then(csv => { renderProfessionalTable(csv); })
        .catch(err => {
            console.warn("Proxy 1 failed:", err);
            const url2 = CONFIG.proxies[1] + encodeURIComponent(sourceUrl);
            fetch(url2)
                .then(r => { if (!r.ok) throw new Error(r.status); return r.text(); })
                .then(csv => { renderProfessionalTable(csv); })
                .catch(() => { renderProfessionalTable(FALLBACK_DATA, true); });
        });
}

const ROLE_COLOR_MAP = {
    "BGH": "tag-bgh", "SGD": "tag-sgd", "TPT": "tag-tpt", "Cƒê": "tag-sgd",
    "Hi·ªáu tr∆∞·ªüng": "tag-name-ht", "HT": "tag-name-ht",
    "Hi·ªáu ph√≥": "tag-name-hp", "HP": "tag-name-hp", "P.HT": "tag-name-hp",
    "T·ªï tr∆∞·ªüng": "tag-name-tt", "TT": "tag-name-tt",
    "GVCN": "tag-name-gvcn", "Gi√°o vi√™n": "tag-name-gv"
};

const DAY_MAP = {
    "Hai": "Th·ª© Hai", "Ba": "Th·ª© Ba", "T∆∞": "Th·ª© T∆∞",
    "NƒÉm": "Th·ª© NƒÉm", "S√°u": "Th·ª© S√°u", "B·∫£y": "Th·ª© B·∫£y", "CN": "Ch·ªß Nh·∫≠t"
};

// T√≠nh to√°n Rowspan cho c·ªôt ƒë·∫ßu ti√™n (G·ªôp Th·ª© & Ng√†y)
function calculateRowSpans(bodyRows) {
    if (bodyRows.length === 0) return [];
    
    const spans = new Array(bodyRows.length).fill(1);
    let previousDay = bodyRows[0][0].trim(); // L·∫•y gi√° tr·ªã c·ªôt ƒë·∫ßu ti√™n (Th·ª©)
    let startIndex = 0;

    for (let i = 1; i < bodyRows.length; i++) {
        const currentDay = bodyRows[i][0].trim();
        // Logic: N·∫øu Th·ª© gi·ªëng nhau th√¨ g·ªôp
        if (currentDay === previousDay && currentDay !== '') {
            spans[startIndex]++;
            spans[i] = 0; // ƒê√°nh d·∫•u √¥ n√†y b·ªã ·∫©n
        } else {
            previousDay = currentDay;
            startIndex = i;
        }
    }
    return spans;
}

function buildTableBody(bodyRows, headers) {
    const spanMap = calculateRowSpans(bodyRows);
    const uniqueDays = new Set();
    
    // T√¨m index c√°c c·ªôt quan tr·ªçng
    // L∆∞u √Ω: headers g·ªëc l√† [Th·ª©, Ng√†y, Time, N·ªôi dung...]
    // Ch√∫ng ta s·∫Ω g·ªôp Th·ª© & Ng√†y n√™n Time s·∫Ω l√† c·ªôt index 2 trong d·ªØ li·ªáu g·ªëc, nh∆∞ng l√† c·ªôt index 1 trong hi·ªÉn th·ªã (sau khi g·ªôp)
    
    // T√¨m v·ªã tr√≠ t∆∞∆°ng ƒë·ªëi
    let idxTimeRaw = -1, idxChuTriRaw = -1, idxKhoiRaw = -1;
    
    headers.forEach((h, i) => {
        const txt = h.toLowerCase();
        if (txt.includes('th·ªùi gian')) idxTimeRaw = i;
        else if (txt.includes('ch·ªß tr√¨')) idxChuTriRaw = i;
        else if (txt.includes('kh·ªëi')) idxKhoiRaw = i;
    });
    
    // N·∫øu kh√¥ng t√¨m th·∫•y, fallback v·ªÅ m·∫∑c ƒë·ªãnh
    if (idxTimeRaw === -1) idxTimeRaw = 2;
    if (idxChuTriRaw === -1) idxChuTriRaw = 4; // V√≠ d·ª•
    if (idxKhoiRaw === -1) idxKhoiRaw = headers.length - 1;

    let bodyHtml = '';

    bodyRows.forEach((row, rIdx) => {
        let rawDay = (row[0] || '').trim();
        if (rawDay !== '') uniqueDays.add(rawDay);

        // Class cho d√≤ng d·ª±a tr√™n Kh·ªëi
        let rowClass = '';
        const khoiVal = (row[idxKhoiRaw] || '').toUpperCase();
        if (khoiVal.includes('THCS')) rowClass = 'row-thcs';
        else if (khoiVal.includes('TH')) rowClass = 'row-th';

        // B·∫Øt ƒë·∫ßu d√≤ng, th√™m data-day ƒë·ªÉ l·ªçc
        bodyHtml += `<tr class="${rowClass}" data-day="${escapeHtml(rawDay)}">`;

        // --- X·ª≠ l√Ω C·ªôt G·ªôp (Th·ª© + Ng√†y) ---
        // Ch·ªâ render n·∫øu span > 0. N·∫øu span = 0 nghƒ©a l√† √¥ b·ªã g·ªôp
        if (spanMap[rIdx] > 0) {
            const dayOfWeek = (row[0] || '').trim();
            const dateVal = (row[1] || '').trim(); // C·ªôt Ng√†y th∆∞·ªùng l√† c·ªôt th·ª© 2
            const fullDayText = DAY_MAP[dayOfWeek] || dayOfWeek;
            
            // N·ªôi dung √¥ g·ªôp
            const cellContent = `<div style="font-size:1.1em; margin-bottom:4px;">${fullDayText}</div><div style="font-weight:400; font-size:0.9em; color:#666;">${dateVal}</div>`;
            
            const rowspanAttr = spanMap[rIdx] > 1 ? ` rowspan="${spanMap[rIdx]}"` : '';
            bodyHtml += `<td class="col-sticky-date"${rowspanAttr}>${cellContent}</td>`;
        }

        // --- X·ª≠ l√Ω c√°c c·ªôt c√≤n l·∫°i (B·∫Øt ƒë·∫ßu t·ª´ c·ªôt 2: Th·ªùi gian) ---
        for (let c = 2; c < headers.length; c++) {
            let cellData = (row[c] || '').trim();
            let cellContent = escapeHtml(cellData).replace(/\n/g, '<br>');
            let cellClass = '';
            
            // X√°c ƒë·ªãnh ki·ªÉu c·ªôt
            if (c === idxTimeRaw) cellClass = 'col-time';
            if (c === idxChuTriRaw) {
                cellClass = 'align-center';
                // T√¥ m√†u tag
                for (const role in ROLE_COLOR_MAP) {
                    const regex = new RegExp(`\\b${role}\\b`, 'gi'); // Case insensitive
                    cellContent = cellContent.replace(regex, (match) => `<span class="tag-common ${ROLE_COLOR_MAP[role]}">${match}</span>`);
                }
            }

            bodyHtml += `<td class="${cellClass}">${cellContent}</td>`;
        }
        bodyHtml += '</tr>';
    });

    return { bodyHtml, uniqueDays };
}

function analyzeScheduleAI(rows, headers) {
    // AI ƒë·∫øm s·ªë l∆∞·ª£ng c√¥ng vi·ªác
    const countTotal = rows.length;
    let countBGH = 0;
    let countHop = 0;
    let busiestDay = { name: '', count: 0 };
    const dayCounts = {};

    rows.forEach(row => {
        const content = row.join(' ').toUpperCase();
        const day = row[0];
        
        if (content.includes('BGH') || content.includes('HI·ªÜU TR∆Ø·ªûNG') || content.includes('HI·ªÜU PH√ì')) countBGH++;
        if (content.includes('H·ªåP') || content.includes('T·∫¨P HU·∫§N')) countHop++;
        
        // ƒê·∫øm ng√†y b·∫≠n r·ªôn
        if(day) {
            dayCounts[day] = (dayCounts[day] || 0) + 1;
        }
    });

    // T√¨m ng√†y b·∫≠n nh·∫•t
    for (const [day, count] of Object.entries(dayCounts)) {
        if (count > busiestDay.count) {
            busiestDay = { name: day, count: count };
        }
    }

    const fullDayName = DAY_MAP[busiestDay.name] || busiestDay.name;

    return `
        <div class="stat-card">T·ªïng ƒë·∫ßu vi·ªác: <span>${countTotal}</span></div>
        <div class="stat-card">L·ªãch BGH/Ch·ªâ ƒë·∫°o: <span>${countBGH}</span></div>
        <div class="stat-card">S·ªë cu·ªôc h·ªçp: <span>${countHop}</span></div>
        <div class="stat-card highlight">Cao ƒëi·ªÉm: <span>${fullDayName} (${busiestDay.count})</span></div>
    `;
}

function renderProfessionalTable(csvText, isDemo = false) {
    try {
        const rawData = parseCSV(csvText);
        // T√¨m d√≤ng ch·ª©a header (c√≥ ch·ªØ 'Th·ª©' ho·∫∑c 'Ng√†y')
        let headerRowIndex = rawData.findIndex(row => row.some(c => c && c.toLowerCase().includes('th·ª©')));
        if (headerRowIndex === -1) headerRowIndex = 2; // M·∫∑c ƒë·ªãnh d√≤ng 3

        const headers = rawData[headerRowIndex];
        // L·ªçc d·ªØ li·ªáu: B·ªè c√°c d√≤ng tr·ªëng ho·∫∑c ch·ªâ c√≥ header l·∫∑p l·∫°i
        const bodyRows = rawData.slice(headerRowIndex + 1).filter(r => {
            const hasData = !r.every(c => c.trim() === '');
            const notHeader = !r[0].includes('Th·ª©');
            return hasData && notHeader;
        });

        // --- Render UI ---
        const headerTarget = document.getElementById('top-info');
        const dashboardTarget = document.getElementById('ai-dashboard');
        const filtersTarget = document.getElementById('day-filters');

        // 1. Top Info (L·∫•y c√°c d√≤ng tr√™n header)
        if (!isDemo) {
            let topHtml = '';
            for (let i = 0; i < headerRowIndex; i++) {
                const info = rawData[i].filter(c => c.trim() !== '').join(' - ');
                if (info) topHtml += (topHtml === '') ? `<h2>${escapeHtml(info)}</h2>` : `<div class="sub-info">${escapeHtml(info)}</div>`;
            }
            headerTarget.innerHTML = topHtml;
        }

        // 2. AI Dashboard
        dashboardTarget.innerHTML = isDemo 
            ? `<div class="stat-card highlight">‚ö†Ô∏è ƒêANG D√ôNG D·ªÆ LI·ªÜU M·∫™U (OFFLINE)</div>` 
            : analyzeScheduleAI(bodyRows, headers);
        dashboardTarget.style.display = "flex";

        // 3. Main Table
        const { bodyHtml, uniqueDays } = buildTableBody(bodyRows, headers);
        
        // Header m·ªõi: G·ªôp Th·ª©+Ng√†y th√†nh 1 c·ªôt "Th·ªùi Gian"
        // headers.slice(2) nghƒ©a l√† b·ªè 2 c·ªôt ƒë·∫ßu (Th·ª©, Ng√†y) c·ªßa file g·ªëc ƒë·ªÉ thay b·∫±ng c·ªôt g·ªôp
        const newHeaders = [`<th>TH·ª® / NG√ÄY</th>`, ...headers.slice(2).map(h => `<th>${escapeHtml(h)}</th>`)];

        const tableHtml = `
            <table class="custom-schedule">
                <thead><tr>${newHeaders.join('')}</tr></thead>
                <tbody>${bodyHtml}</tbody>
            </table>`;
        document.getElementById('main-table').innerHTML = tableHtml;

        // 4. Filters
        let filtersHtml = `<button class="filter-btn active" onclick="setDayFilter('all', this)">T·∫•t c·∫£</button>`;
        uniqueDays.forEach(day => {
            if(day.length < 10) { // Ch·ªâ l·∫•y t√™n th·ª© ng·∫Øn g·ªçn
                filtersHtml += `<button class="filter-btn" onclick="setDayFilter('${escapeHtml(day)}', this)">${escapeHtml(day)}</button>`;
            }
        });
        filtersTarget.innerHTML = filtersHtml;
        filtersTarget.style.display = 'flex';

        // Done
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('main-table').style.display = 'block';
        document.getElementById('search-area').style.display = 'flex';

    } catch (e) { 
        console.error(e);
        showError("L·ªói x·ª≠ l√Ω d·ªØ li·ªáu: " + e.message); 
    }
}

// --- FILTER & INTERACTION ---
function filterTable() {
    const input = document.getElementById("searchInput");
    const textFilter = input.value.toUpperCase();
    const table = document.querySelector("table.custom-schedule");
    if (!table) return;

    const rows = table.querySelector("tbody").getElementsByTagName("tr");
    
    // L∆∞u √Ω: Khi filter text, c·∫•u tr√∫c rowspan c√≥ th·ªÉ l√†m giao di·ªán h∆°i l·ªách 1 ch√∫t ·ªü c·ªôt Ng√†y
    // Nh∆∞ng logic hi·ªÉn th·ªã v·∫´n ƒë·∫£m b·∫£o ƒë√∫ng d·ªØ li·ªáu.
    
    for (const row of rows) {
        const rowDay = row.getAttribute('data-day');
        const dayMatch = (currentFilterDay === 'all') || (rowDay === currentFilterDay);
        const textMatch = textFilter === "" || row.textContent.toUpperCase().includes(textFilter);

        if (dayMatch && textMatch) {
            row.style.display = "";
        } else {
            row.style.display = "none";
        }
    }
}

function setDayFilter(day, btnElement) {
    currentFilterDay = day;
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btnElement.classList.add('active');
    
    document.getElementById('searchInput').value = '';
    filterTable();
}

document.addEventListener('DOMContentLoaded', loadScheduleData);
</script>
</body>
</html>
