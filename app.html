<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L·ªãch C√¥ng T√°c Th√¥ng Minh v6.2 - Auto Update</title>
    <style>
        /* --- CORE RESET & FONT --- */
        body { margin: 0; padding: 0; background-color: #f4f6f9; }
        #schedule-container { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 20px auto; width: 98%; max-width: 1400px; box-sizing: border-box; color: #333; background: white; padding: 20px; box-shadow: 0 0 20px rgba(0,0,0,0.05); border-radius: 8px; }
        
        /* --- HEADER & DASHBOARD --- */
        .schedule-header h2 { text-align: center; color: #1a237e; margin: 0 0 10px 0; text-transform: uppercase; font-size: 26px; font-weight: 800; letter-spacing: 1px; }
        .schedule-header .sub-info { text-align: center; color: #555; margin-bottom: 15px; font-weight: 600; font-size: 16px; }
        
        /* Dashboard */
        .dashboard-panel { display: flex; justify-content: center; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; display: none; }
        .stat-card { background: linear-gradient(135deg, #f6f9fc 0%, #eef2f3 100%); padding: 10px 20px; border-radius: 8px; border-left: 5px solid #4472C4; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 14px; font-weight: bold; color: #444; }
        .stat-card span { color: #d32f2f; font-size: 1.2em; margin-left: 5px; }
        .stat-card.alert-mode { border-left-color: #d32f2f; background: #fff0f0; color: #d32f2f; }
        #notification-control { cursor: pointer; }

        /* --- SMART FILTER TABS --- */
        .filter-tabs { display: flex; justify-content: center; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; display: none; }
        .filter-btn {
            padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 20px;
            cursor: pointer; font-size: 14px; font-weight: 600; color: #555; transition: all 0.2s;
        }
        .filter-btn:hover { background: #f0f0f0; }
        .filter-btn.active { background: #4472C4; color: white; border-color: #4472C4; box-shadow: 0 4px 10px rgba(68, 114, 196, 0.3); }

        /* --- LOADING --- */
        #loading-state { text-align: center; padding: 40px; color: #007bff; display: block; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { color: #d32f2f; background: #ffebee; padding: 15px; border-radius: 5px; border: 1px solid #ffcdd2; margin-top: 10px; display: inline-block; font-weight: bold; }

        /* --- TOOLS --- */
        .search-wrapper { display: flex; justify-content: space-between; margin-bottom: 15px; gap: 10px; display: none; }
        #searchInput { flex-grow: 1; padding: 12px 15px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; transition: border-color 0.3s; }
        #searchInput:focus { border-color: #4472C4; outline: none; }
        .btn-print { background-color: #4472C4; color: white; border: none; padding: 0 25px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: background 0.2s; white-space: nowrap; }
        .btn-print:hover { background-color: #365a9e; }

        /* --- TABLE --- */
        .table-responsive { overflow: auto; max-height: 80vh; border: 1px solid #ccc; box-shadow: 0 4px 15px rgba(0,0,0,0.08); border-radius: 4px; position: relative; display: none; }
        table.custom-schedule { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 1000px; font-size: 14px; background-color: white; }
        table.custom-schedule thead th { background-color: #4472C4; color: white; padding: 14px 10px; text-align: center; border: 1px solid #fff; border-bottom: 2px solid #2c4a85; white-space: nowrap; font-weight: bold; text-transform: uppercase; position: sticky; top: 0; z-index: 10; }
        table.custom-schedule td { border: 1px solid #b0b0b0; padding: 10px 12px; vertical-align: middle; color: #222; line-height: 1.5; }
        
        table.custom-schedule td.col-sticky-date { background-color: #A9D08E !important; font-weight: bold; text-align: center; color: #000; position: sticky; left: 0; z-index: 5; border-right: 2px solid #888; }
        table.custom-schedule td.col-time { font-weight: bold; text-align: center; white-space: nowrap; color: #d32f2f; background-color: #fffaf0; }
        table.custom-schedule td.align-center { text-align: center; }
        
        tr.row-th td:not(.col-sticky-date) { background-color: #E2EFDA; }
        tr.row-thcs td:not(.col-sticky-date) { background-color: #DDEBF7; }
        table.custom-schedule tbody tr:hover td:not(.col-sticky-date) { background-color: #fffce7; cursor: default; }

        /* No results row */
        .no-results-row td { text-align: center; font-style: italic; color: #777; padding: 20px; background-color: #fafafa !important; }

        /* Tags */
        .tag-common { padding: 4px 8px; border-radius: 4px; font-weight: 700; font-size: 0.9em; display: inline-block; margin: 2px; box-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        .tag-bgh { background-color: #FFC000; color: #000; }
        .tag-tpt { background-color: #FFE699; color: #333; }
        .tag-sgd { background-color: #9BC2E6; color: #003366; }

        /* Tags cho t√™n ng∆∞·ªùi ch·ªß tr√¨ */
        .tag-name-ht { background-color: #ffcdd2; color: #c62828; }
        .tag-name-hp { background-color: #c8e6c9; color: #2e7d32; }
        .tag-name-tt { background-color: #bbdefb; color: #1565c0; }
        .tag-name-gv { background-color: #f5f5f5; color: #424242; border: 1px solid #e0e0e0;}

        /* --- UPDATE NOTIFICATION --- */
        .update-notification {
            background-color: #28a745; /* Green for success */
            color: white;
            text-align: center;
            padding: 15px;
            font-weight: bold;
            border-radius: 8px;
            position: fixed; /* N·ªïi tr√™n n·ªôi dung */
            top: 20px;
            left: 50%;
            transform: translate(-50%, -150%); /* ·∫®n ·ªü tr√™n v√† cƒÉn gi·ªØa */
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: transform 0.5s ease-in-out;
            cursor: pointer;
        }
        .update-notification.show {
            transform: translate(-50%, 0); /* Tr∆∞·ª£t xu·ªëng ƒë·ªÉ hi·ªán ra */
        }

        @media print {
            body { background: white; }
            #schedule-container { box-shadow: none; width: 100%; margin: 0; padding: 0; max-width: none; }
            .search-wrapper, #ai-dashboard, .filter-tabs, .btn-print { display: none !important; }
            .table-responsive { overflow: visible; max-height: none; border: none; display: block !important; }
            table.custom-schedule th { background-color: #ccc !important; color: black !important; -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body>

<div id="schedule-container">
    <div id="update-notification" class="update-notification"></div>

    <div id="top-info" class="schedule-header"></div>
    
    <div id="ai-dashboard" class="dashboard-panel"></div>

    <div id="day-filters" class="filter-tabs"></div>
    
    <div id="loading-state">
        <div class="spinner"></div> 
        <span id="loading-text">AI ƒëang ƒë·ªìng b·ªô d·ªØ li·ªáu...</span>
    </div>

    <div id="search-area" class="search-wrapper">
        <input type="text" id="searchInput" placeholder="üîç T√¨m ki·∫øm n·ªôi dung c·ª• th·ªÉ trong l·ªãch..." title="Nh·∫≠p t·ª´ kh√≥a ƒë·ªÉ t√¨m ki·∫øm">
        <button onclick="window.print()" class="btn-print" title="In ho·∫∑c xu·∫•t ra PDF">üñ®Ô∏è In L·ªãch</button>
    </div>

    <div id="main-table" class="table-responsive"></div>
</div>

<script>
/**
 * AI SUPER-SCHEDULER v6.2 (Integrate Auto-Update)
 * Fix l·ªói: G·ªôp t·∫•t c·∫£ script v√†o m·ªôt kh·ªëi duy nh·∫•t ƒë·ªÉ tr√°nh l·ªói hi·ªÉn th·ªã text.
 */
const CONFIG = {
    sheetID: '2PACX-1vSheQFXC-BtDQtik0k6-_exzRtP2qt7sVhPOnnYsJv-aR5gDWIasN8XS8rqXrAcmopof0utvzZZHe0A',
    sheetGid: '2028559314',
    proxies: [
        'https://api.codetabs.com/v1/proxy?quest=',
        'https://api.allorigins.win/raw?url=',
        'https://corsproxy.io/?'
    ]
};

const FALLBACK_DATA = `
L·ªäCH C√îNG T√ÅC TU·∫¶N (CH·∫æ ƒê·ªò OFFLINE)
T·ª´ ng√†y 01/01 ƒë·∫øn 07/01
Th·ª©,Ng√†y,Th·ªùi gian,N·ªôi dung,ƒê·ªãa ƒëi·ªÉm,Ch·ªß tr√¨,Th√†nh ph·∫ßn,Ghi ch√∫,Kh·ªëi
Hai,01/01,07:00,Ch√†o c·ªù (M·∫´u),S√¢n tr∆∞·ªùng,BGH,To√†n tr∆∞·ªùng,,THCS
Hai,01/01,08:00,H·ªçp BGH,Ph√≤ng HT,BGH,BGH,,TH
Ba,02/01,14:00,T·∫≠p hu·∫•n,H·ªôi tr∆∞·ªùng,SGD,GV,,THCS
`;

const NAME_COLOR_MAP = {
    "Hi·ªáu tr∆∞·ªüng": "tag-name-ht", "HT": "tag-name-ht",
    "Hi·ªáu ph√≥": "tag-name-hp", "HP": "tag-name-hp",
    "T·ªï tr∆∞·ªüng": "tag-name-tt"
};

const TAG_COLOR_MAP = {
    "BGH": "tag-bgh", "TPT": "tag-tpt", "SGD": "tag-sgd",
    ...NAME_COLOR_MAP
};
const TAG_REGEX = new RegExp(`\\b(${Object.keys(TAG_COLOR_MAP).join('|')})\\b`, 'g');

const App = {
    currentFilterDay: 'all',
    filterTimeout: null,
    CACHE_KEY: 'smart_schedule_cache_v1',

    init() {
        document.addEventListener('DOMContentLoaded', () => {
            // Chi·∫øn thu·∫≠t Smart Cache: Hi·ªÉn th·ªã cache tr∆∞·ªõc, t·∫£i m·ªõi sau
            this.loadFromCache();
            this.loadScheduleData();
        });
    },

    setupEventListeners() {
        const searchInput = document.getElementById('searchInput');
        if(searchInput) {
            searchInput.addEventListener('keyup', () => {
                clearTimeout(this.filterTimeout);
                this.filterTimeout = setTimeout(() => this.filterTable(), 300);
            });
        }

        const notification = document.getElementById('update-notification');
        if (notification) {
            notification.addEventListener('click', () => {
                notification.classList.remove('show');
            });
        }
    },

    setupNotifications() {
        const control = document.getElementById('notification-control');
        if (!control || !('Notification' in window)) {
            if(control) control.style.display = 'none';
            return;
        }

        const updateStatus = (permission) => {
            const statusEl = document.getElementById('notification-status');
            if (!statusEl) return;
            if (permission === 'granted') {
                statusEl.textContent = '‚úÖ ƒê√£ b·∫≠t th√¥ng b√°o';
                control.style.borderLeftColor = '#28a745';
            } else if (permission === 'denied') {
                statusEl.textContent = 'üö´ ƒê√£ ch·∫∑n th√¥ng b√°o';
                control.style.borderLeftColor = '#d32f2f';
            } else {
                statusEl.textContent = 'üîî B·∫≠t th√¥ng b√°o tr√¨nh duy·ªát';
                control.style.borderLeftColor = '#fbc02d';
            }
        };

        updateStatus(Notification.permission);

        control.addEventListener('click', () => Notification.requestPermission().then(updateStatus));
    },

    showError(msg) {
        const loadingEl = document.getElementById('loading-state');
        if (loadingEl) loadingEl.innerHTML = `<div class="error-msg">‚ö†Ô∏è ${msg}</div>`;
    },

    parseCSV(text) {
        const rows = [];
        let currentRow = [];
        let currentVal = '';
        let inQuote = false;
        for (let i = 0; i < text.length; i++) {
            const char = text[i], nextChar = text[i + 1];
            if (char === '"') { inQuote ? (nextChar === '"' ? (currentVal += '"', i++) : inQuote = !inQuote) : inQuote = !inQuote; } 
            else if (char === ',' && !inQuote) { currentRow.push(currentVal); currentVal = ''; } 
            else if ((char === '\r' || char === '\n') && !inQuote) { 
                if (char === '\r' && nextChar === '\n') i++; 
                currentRow.push(currentVal); rows.push(currentRow); currentRow = []; currentVal = ''; 
            } else { currentVal += char; }
        }
        if (currentRow.length > 0 || currentVal !== '') { currentRow.push(currentVal); rows.push(currentRow); }
        return rows;
    },

    filterTable() {
        const input = document.getElementById("searchInput");
        const textFilter = input.value.toUpperCase();
        const table = document.querySelector("table.custom-schedule");
        if (!table) return;

        const rows = table.querySelector("tbody").getElementsByTagName("tr");
        let visibleRowCount = 0;

        for (const row of rows) {
            if (row.classList.contains('no-results-row')) continue;
            const rowDay = row.getAttribute('data-day');
            const dayMatch = (this.currentFilterDay === 'all') || (rowDay === this.currentFilterDay);
            const textMatch = textFilter === "" || row.textContent.toUpperCase().includes(textFilter);

            if (dayMatch && textMatch) {
                row.style.display = "";
                visibleRowCount++;
            } else {
                row.style.display = "none";
            }
        }

        let noResultsRow = table.querySelector('.no-results-row');
        if (visibleRowCount === 0) {
            if (!noResultsRow) {
                noResultsRow = table.querySelector("tbody").insertRow();
                noResultsRow.className = 'no-results-row';
                const colCount = table.querySelector('thead th') ? table.querySelector('thead th').length : 9;
                noResultsRow.innerHTML = `<td colspan="${colCount}">Kh√¥ng t√¨m th·∫•y n·ªôi dung ph√π h·ª£p.</td>`;
            }
            noResultsRow.style.display = "";
        } else if (noResultsRow) {
            noResultsRow.style.display = "none";
        }
    },

    setDayFilter(day, btnElement) {
        this.currentFilterDay = day;
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btnElement.classList.add('active');
        const searchInput = document.getElementById('searchInput');
        if(searchInput) searchInput.value = '';
        this.filterTable();
    },

    loadFromCache() {
        const cached = localStorage.getItem(this.CACHE_KEY);
        if (cached) {
            console.log("Loading from Smart Cache...");
            this.renderProfessionalTable(cached, false);
        }
    },

    loadScheduleData() {
        const sourceUrl = `https://docs.google.com/spreadsheets/d/e/${CONFIG.sheetID}/pub?gid=${CONFIG.sheetGid}&single=true&output=csv`;
        
        // Th·ª≠ proxy 1
        fetch(CONFIG.proxies[0] + encodeURIComponent(sourceUrl))
            .then(res => { if (!res.ok) throw new Error("Proxy 1 failed"); return res.text(); })
            .then(csv => this.processNewData(csv))
            .catch(err => {
                console.warn("Chuy·ªÉn sang Proxy 2...", err);
                // Th·ª≠ proxy 2
                fetch(CONFIG.proxies[1] + encodeURIComponent(sourceUrl))
                    .then(r => { if (!r.ok) throw new Error("Proxy 2 failed"); return r.text(); })
                    .then(csv => this.processNewData(csv))
                    .catch(() => { 
                        // N·∫øu th·∫•t b·∫°i h·∫øt, ch·ªâ hi·ªán Fallback n·∫øu ch∆∞a c√≥ cache
                        if(!localStorage.getItem(this.CACHE_KEY)) {
                            this.renderProfessionalTable(FALLBACK_DATA, true); 
                        }
                    });
            });
    },

    processNewData(newCsv) {
        const oldCsv = localStorage.getItem(this.CACHE_KEY);
        
        // N·∫øu c√≥ d·ªØ li·ªáu c≈© v√† d·ªØ li·ªáu m·ªõi kh√°c d·ªØ li·ªáu c≈© -> c√≥ c·∫≠p nh·∫≠t
        if (oldCsv && oldCsv !== newCsv) {
            const notification = document.getElementById('update-notification');
            if (notification && !notification.classList.contains('show')) {
                notification.innerText = '‚ú® L·ªãch c√¥ng t√°c v·ª´a ƒë∆∞·ª£c c·∫≠p nh·∫≠t!';
                notification.classList.add('show');
                // T·ª± ƒë·ªông ·∫©n sau 5 gi√¢y
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 5000);

                // G·ª≠i th√¥ng b√°o g·ªëc c·ªßa tr√¨nh duy·ªát n·∫øu ƒë∆∞·ª£c ph√©p
                if ('Notification' in window && Notification.permission === 'granted') {
                    const iconUrl = 'https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png';
                    new Notification('L·ªãch C√¥ng T√°c', { body: 'V·ª´a c√≥ c·∫≠p nh·∫≠t m·ªõi!', icon: iconUrl, tag: 'schedule-update' });
                }
            }
        }

        localStorage.setItem(this.CACHE_KEY, newCsv); // L∆∞u d·ªØ li·ªáu m·ªõi v√†o cache
        this.renderProfessionalTable(newCsv); // Hi·ªÉn th·ªã d·ªØ li·ªáu m·ªõi
    },

    // --- LOGIC FUNCTIONS (ƒê√£ ƒë∆∞·ª£c s·ª≠a l·ªói c√∫ ph√°p) ---
    calculateRowSpans(bodyRows, headers) {
        if (!bodyRows || bodyRows.length === 0) return [];

        // X√°c ƒë·ªãnh c√°c c·ªôt c·∫ßn g·ªôp nh√≥m
        const idxDay = 0; // Th·ª©
        const idxDate = 1; // Ng√†y
        const idxTime = headers.findIndex(c => c.toLowerCase().includes('th·ªùi gian'));
        const colsToMerge = [idxDay, idxDate, idxTime].filter(i => i !== -1);

        // Kh·ªüi t·∫°o map cho t·∫•t c·∫£ c√°c c·ªôt
        const spanMap = bodyRows.map(() => Array(headers.length).fill(1));
        let currentSpanStart = 0;

        for (let i = 1; i < bodyRows.length; i++) {
            // Ki·ªÉm tra xem t·∫•t c·∫£ c√°c c·ªôt c·∫ßn g·ªôp c√≥ gi·ªëng nhau kh√¥ng
            const shouldMerge = colsToMerge.every(colIdx => {
                const prev = (bodyRows[i - 1][colIdx] || '').trim();
                const cur = (bodyRows[i][colIdx] || '').trim();
                return cur === prev && cur !== '';
            });

            if (shouldMerge) {
                colsToMerge.forEach(colIdx => {
                    spanMap[i][colIdx] = 0;
                    spanMap[currentSpanStart][colIdx]++;
                });
            } else {
                currentSpanStart = i;
            }
        }
        return spanMap;
    },

    applyColorTags(text, isChuTriColumn) {
        if (!text) return '';
        if (!isChuTriColumn) {
            return text
                .replace(/\bBGH\b/g, '<span class="tag-common tag-bgh">BGH</span>')
                .replace(/\bTPT\b/g, '<span class="tag-common tag-tpt">TPT</span>')
                .replace(/\bSGD\b/g, '<span class="tag-common tag-sgd">SGD</span>');
        }
        return text.replace(TAG_REGEX, (match) => `<span class="tag-common ${TAG_COLOR_MAP[match]}">${match}</span>`);
    },

    buildTableBody(bodyRows, headers) {
        const spanMap = this.calculateRowSpans(bodyRows, headers);
        const uniqueDays = new Set();
        let currentDayValue = '';

        const idxTime = headers.findIndex(c => c.toLowerCase().includes('th·ªùi gian'));
        const idxChuTri = headers.findIndex(c => c.toLowerCase().includes('ch·ªß tr√¨'));
        const idxKhoi = headers.length - 1;

        let bodyHtml = '';
        bodyRows.forEach((row, rIdx) => {
            let rawDay = (row[0] || '').trim();
            if (rawDay !== '') {
                currentDayValue = rawDay;
                uniqueDays.add(rawDay);
            }

            let rowClass = '';
            const khoiVal = (row[idxKhoi] || '').toUpperCase();
            if (khoiVal.includes('THCS')) rowClass = 'row-thcs';
            else if (khoiVal.includes('TH')) rowClass = 'row-th';

            bodyHtml += `<tr class="${rowClass}" data-day="${this.escapeHtml(currentDayValue)}">`;

            for (let c = 0; c < headers.length; c++) {
                let cellData = (row[c] || '').trim();
                let cellContent = this.escapeHtml(cellData).replace(/\n/g, '<br>');
                let cellClass = '';
                let rowspanAttr = '';

                // Logic g·ªôp √¥ (rowspan) ƒë√£ ƒë∆∞·ª£c n√¢ng c·∫•p
                if (spanMap[rIdx] && spanMap[rIdx][c] === 0) continue;
                if (spanMap[rIdx] && spanMap[rIdx][c] > 1) rowspanAttr = ` rowspan="${spanMap[rIdx][c]}"`;

                if (c === 0 || c === 1) {
                    cellClass = 'col-sticky-date';
                }
                if (c === idxTime) cellClass += ' col-time';
                if (c === idxChuTri) cellClass += ' align-center';

                bodyHtml += `<td class="${cellClass.trim()}"${rowspanAttr}>${this.applyColorTags(cellContent, c === idxChuTri)}</td>`;
            }
            bodyHtml += '</tr>';
        });

        return { bodyHtml, uniqueDays };
    },

    renderProfessionalTable(csvText, isDemo = false) {
        try {
            const rawData = this.parseCSV(csvText);
            // T√¨m d√≤ng ti√™u ƒë·ªÅ ch·ª©a ch·ªØ "Th·ª©"
            const headerRowIndex = rawData.findIndex(row => row.some(c => c && c.toLowerCase().includes('th·ª©'))) || 0;
            
            if (headerRowIndex === -1 || rawData.length < headerRowIndex + 2) {
                throw new Error("D·ªØ li·ªáu CSV kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng l·ªãch.");
            }

            const headers = rawData[headerRowIndex];
            const bodyRows = rawData.slice(headerRowIndex + 1).filter(r => !r.every(c => c.trim() === ''));

            // UI Elements
            const headerTarget = document.getElementById('top-info');
            const dashboardTarget = document.getElementById('ai-dashboard');
            const filtersTarget = document.getElementById('day-filters');

            // 1. Top Info Header
            if (!isDemo && headerRowIndex > 0) {
                let topHtml = '';
                for (let i = 0; i < headerRowIndex; i++) {
                    const info = rawData[i].filter(c => c.trim() !== '').join(' - ');
                    if (info) topHtml += (topHtml === '') ? `<h2>${this.escapeHtml(info)}</h2>` : `<div class="sub-info">${this.escapeHtml(info)}</div>`;
                }
                headerTarget.innerHTML = topHtml;
            }

            // 2. Dashboard Stat
            if (isDemo) {
                dashboardTarget.innerHTML = `<div class="stat-card alert-mode">‚ö†Ô∏è CH·∫æ ƒê·ªò OFFLINE / M·∫™U</div>`;
            } else {
                let countBGH = bodyRows.filter(r => r.join(' ').toUpperCase().includes('BGH')).length;
                let countAll = bodyRows.length;
                dashboardTarget.innerHTML = `
                    <div class="stat-card">T·ªïng s·ª± ki·ªán: <span>${countAll}</span></div>
                    ${countBGH > 0 ? `<div class="stat-card">H·ªçp/C√¥ng t√°c BGH: <span>${countBGH}</span></div>` : ''}
                    <div id="notification-control" class="stat-card" title="Nh·∫•n ƒë·ªÉ cho ph√©p tr√¨nh duy·ªát g·ª≠i th√¥ng b√°o khi c√≥ l·ªãch m·ªõi">
                        <span id="notification-status"></span>
                    </div>
                `;
            }
            dashboardTarget.style.display = "flex";

            // 3. Render Table
            const { bodyHtml, uniqueDays } = this.buildTableBody(bodyRows, headers);
            const tableHtml = `
                <table class="custom-schedule">
                    <thead><tr>${headers.map(h => `<th>${this.escapeHtml(h)}</th>`).join('')}</tr></thead>
                    <tbody>${bodyHtml}</tbody>
                </table>`;
            document.getElementById('main-table').innerHTML = tableHtml;

            // 4. Filter Buttons
            let filtersHtml = `<button class="filter-btn active" onclick="App.setDayFilter('all', this)">T·∫•t c·∫£ c√°c ng√†y</button>`;
            uniqueDays.forEach(day => {
                if(day.length < 25) { // Ch·ªâ hi·ªán n√∫t n·∫øu t√™n ng√†y kh√¥ng qu√° d√†i
                    filtersHtml += `<button class="filter-btn" onclick="App.setDayFilter('${this.escapeHtml(day)}', this)">${this.escapeHtml(day)}</button>`;
                }
            });
            filtersTarget.innerHTML = filtersHtml;
            filtersTarget.style.display = 'flex';

            // 5. Show Final UI
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('main-table').style.display = 'block';
            document.getElementById('search-area').style.display = 'flex';

            // G√°n s·ª± ki·ªán sau khi UI ƒë√£ ƒë∆∞·ª£c render ho√†n ch·ªânh
            this.setupEventListeners();
            this.setupNotifications();
        } catch (e) { 
            console.error(e);
            this.showError("L·ªói hi·ªÉn th·ªã: " + e.message); 
        }
    },

    escapeHtml(text) {
        if (!text) return '';
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
    }
};

/**
 * AI SYSTEM: THEO D√ïI C·∫¨P NH·∫¨T GITHUB PAGES (Ch·∫°y song song)
 * T·ª± ƒë·ªông reload trang khi file app.html tr√™n server thay ƒë·ªïi.
 */
function initGitHubUpdateTracker() {
    if (!("Notification" in window)) return;
    
    // Y√™u c·∫ßu quy·ªÅn n·∫øu ch∆∞a c√≥
    if (Notification.permission !== "granted") {
        Notification.requestPermission();
    }

    const currentUrl = window.location.href.split('?')[0]; 
    const checkInterval = 30000; // 30s check 1 l·∫ßn
    let storedLastModified = localStorage.getItem('gh_last_modified');

    setInterval(async () => {
        try {
            const checkUrl = currentUrl + '?t=' + new Date().getTime();
            const response = await fetch(checkUrl, { method: 'HEAD', cache: 'no-cache' });

            if (response.ok) {
                const newLastModified = response.headers.get('last-modified');
                if (!storedLastModified) {
                    storedLastModified = newLastModified;
                    localStorage.setItem('gh_last_modified', newLastModified);
                    return;
                }

                if (newLastModified && newLastModified !== storedLastModified) {
                    console.log("GitHub Page Updated:", newLastModified);
                    storedLastModified = newLastModified;
                    localStorage.setItem('gh_last_modified', newLastModified);

                    if (Notification.permission === "granted") {
                        const n = new Notification("C·∫≠p Nh·∫≠t H·ªá Th·ªëng!", {
                            body: "Trang web ƒë√£ c√≥ phi√™n b·∫£n m·ªõi. B·∫•m ƒë·ªÉ t·∫£i l·∫°i.",
                            icon: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
                            requireInteraction: true
                        });
                        n.onclick = function() { window.location.reload(); n.close(); };
                    }
                }
            }
        } catch (e) { console.error("Update Check Error:", e); }
    }, checkInterval);
}

// KH·ªûI CH·∫†Y TO√ÄN B·ªò H·ªÜ TH·ªêNG
App.init();
initGitHubUpdateTracker();
</script>
</body>
</html>
