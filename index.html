<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L·ªãch C√¥ng T√°c BHS - V10.8 BGH HIGHLIGHT EXPANSION</title>
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#4472C4">
    
    <link rel="icon" type="image/png" href="https://drive.google.com/uc?export=download&id=16GLGOJ6r9kM9qEtkCdTiRpvDNDUksuQI&v=10.5">
    <link rel="shortcut icon" type="image/png" href="https://drive.google.com/uc?export=download&id=16GLGOJ6r9kM9qEtkCdTiRpvDNDUksuQI&v=10.5">
    <link rel="apple-touch-icon" href="https://drive.google.com/uc?export=download&id=16GLGOJ6r9kM9qEtkCdTiRpvDNDUksuQI&v=10.5">
    
    <style>
        /* --- CSS BASE --- */
        body { margin: 0; padding: 0; background-color: #fff; scroll-behavior: smooth; overflow-x: hidden; }
        
        #schedule-container { 
            font-family: 'Google Sans', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; width: 100%; max-width: 100%; box-sizing: border-box; 
            color: #333; background: white; padding: 10px; min-height: 100vh;
        }
        
        .schedule-header h2 { 
            text-align: center; color: #1a237e; margin: 10px 0 20px 0; 
            text-transform: uppercase; font-size: 24px; font-weight: 900; 
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        /* DASHBOARD & FILTER */
        .dashboard-panel { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; display: none; }
        .stat-card { 
            background: white; padding: 10px 25px; border-radius: 12px; border: 1px solid #e0e0e0; 
            font-size: 15px; font-weight: 700; color: #333; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            min-width: 110px; text-align: center; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .stat-card span.stat-num { color: #d32f2f; font-size: 1.2em; font-weight: 800; }
        .stat-card span.stat-date { color: #198754; font-size: 1.2em; font-weight: 800; }
        .stat-card.clickable { cursor: pointer; border-color: #198754; }

        .filter-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-btn { 
            padding: 8px 20px; border: 1px solid #e0e0e0; background: #f8f9fa; border-radius: 20px; 
            cursor: pointer; font-size: 14px; font-weight: 600; color: #5f6368; 
            transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .filter-btn.active { 
            background: linear-gradient(135deg, #4472C4 0%, #2b4f94 100%); color: white; border-color: transparent; 
            box-shadow: 0 4px 10px rgba(60, 100, 193, 0.4);
        }
        
        /* TABLE STYLES */
        .table-responsive { 
            overflow: auto; max-height: 85vh; border: 1px solid #e0e0e0; border-radius: 10px; 
            position: relative; display: none; scrollbar-width: thin; -webkit-overflow-scrolling: touch; 
        }
        
        table.custom-schedule { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 1000px; font-size: 15px; background-color: white; }
        
        table.custom-schedule thead th { 
            background: linear-gradient(180deg, #4472C4 0%, #365da3 100%); color: #ffffff !important; 
            padding: 16px 10px; text-align: center; border-right: 1px solid rgba(255,255,255,0.2); 
            white-space: nowrap; font-weight: 800; text-transform: uppercase; 
            position: sticky; top: 0; z-index: 30; 
        }

        table.custom-schedule td { 
            border-bottom: 1px solid #e0e0e0; border-right: 1px solid #e0e0e0; 
            padding: 12px 14px; vertical-align: middle; color: #333; line-height: 1.5; cursor: pointer; 
        }
        
        /* HIGHLIGHT ROW SELECTED */
        tr.row-selected td { background-color: #ffe082 !important; color: #000 !important; }
        tr.row-selected td.col-sticky-date { background-color: #ffca28 !important; color: #000 !important; border-right: 2px solid #ff6f00 !important; }
        tr.row-selected td.col-time { background-color: #ffd54f !important; color: #b71c1c !important; }
        
        @media (hover: hover) {
            table.custom-schedule tbody tr:hover td { background-color: #f1f8ff; }
        }

        .col-hidden { display: none !important; }
        .col-thu { min-width: 80px !important; text-align: center; font-weight: 700 !important; color: #1565c0 !important; }

        table.custom-schedule td.col-sticky-date, table.custom-schedule th.col-sticky-date { 
            background-color: #f8fbff; font-weight: 700; text-align: center; color: #1565c0; 
            position: sticky; left: 0; z-index: 10; border-right: 2px solid #b0bec5; 
        }
        table.custom-schedule th.col-sticky-date { z-index: 35; }

        table.custom-schedule td.col-time { 
            font-weight: 700; text-align: center; white-space: nowrap; color: #c62828; background-color: #fffafa; 
        }

        /* MOBILE FIXES */
        @media screen and (max-width: 768px) {
            #schedule-container { padding: 5px; }
            .schedule-header h2 { font-size: 18px; margin-bottom: 15px; }
            
            table.custom-schedule td.col-sticky-date { position: static !important; z-index: 1 !important; border-right: 1px solid #e0e0e0 !important; }
            table.custom-schedule th.col-sticky-date { position: sticky !important; top: 0 !important; left: 0 !important; z-index: 40 !important; border-right: 1px solid rgba(255,255,255,0.2) !important; }
            table.custom-schedule td.col-time { position: sticky !important; left: 0 !important; z-index: 25 !important; border-right: 2px solid #888 !important; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
            table.custom-schedule thead th { position: sticky !important; top: 0 !important; z-index: 40 !important; }
            table.custom-schedule thead th.col-time { position: sticky !important; left: 0 !important; top: 0 !important; z-index: 50 !important; border-right: 2px solid #fff !important; background: #365da3 !important; }
            
            tr.is-today td.col-time { background-color: #8fd19e !important; border-right: 2px solid #0f5132 !important; }
        }

        /* TODAY HIGHLIGHT */
        tr.is-today { scroll-margin-top: 160px; }
        tr.is-today td { background-color: #c3e6cb !important; color: #000 !important; border-bottom: 1px solid #8fd19e !important; }
        tr.is-today td.col-sticky-date { background-color: #8fd19e !important; color: #064420 !important; }
        tr.is-today td.col-thu { color: #064420 !important; }
        
        #loading-state { text-align: center; padding: 50px; color: #4472C4; }
        .spinner { border: 4px solid rgba(68, 114, 196, 0.1); border-top: 4px solid #4472C4; border-radius: 50%; width: 40px; height: 40px; animation: spin 0.8s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #install-app-btn { display: none; background: #202124; color: white; border: none; padding: 10px 24px; border-radius: 30px; font-weight: bold; margin-bottom: 15px; }
        .tag-bgh { background-color: #FFC000; color: #000; padding: 4px 10px; border-radius: 6px; font-weight: 800; display: inline-block; }
        #toast-notify { visibility: hidden; min-width: 250px; background: #198754; color: #fff; text-align: center; border-radius: 50px; padding: 12px; position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 99999; opacity: 0; transition: opacity 0.5s; font-weight: bold; }
        #toast-notify.show { visibility: visible; opacity: 1; }
    </style>
</head>
<body>

<div id="schedule-container">
    <div style="text-align: center;">
        <button id="install-app-btn">üì≤ C√†i App</button>
    </div>
    
    <div id="top-info" class="schedule-header"></div>
    <div id="ai-dashboard" class="dashboard-panel"></div>
    <div id="day-filters" class="filter-tabs"></div>
    
    <div id="loading-state"><div class="spinner"></div><span id="loading-text" style="font-weight: 600;">ƒêang t·∫£i...</span></div>
    <div id="main-table" class="table-responsive"></div>
</div>
<div id="toast-notify">üîî L·ªãch c√≥ th√¥ng b√°o m·ªõi!</div>

<script>
/**
 * AI SUPER-SCHEDULER V10.8 - BGH HIGHLIGHT EXPANSION
 * - Feature: Applied BGH tag highlighting to BOTH "Ch·ªß tr√¨" and "Th√†nh ph·∫ßn" columns.
 * - Logic: Updated column index check in rendering loop.
 */

const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbysvLenfsJak8UG4UHJfqBG1Kao-VFHVQgJ3MlK6V4VvZi0hGP6wMNEGs0Gk7DOJMiDig/exec'; 

const FALLBACK_DATA = `L·ªäCH C√îNG T√ÅC TU·∫¶N (OFFLINE)\nNG√ÄY,TH·ª®,TH·ªúI GIAN,N·ªòI DUNG,ƒê·ªäA ƒêI·ªÇM,CH·ª¶ TR√å,TH√ÄNH PH·∫¶N,GHI CH√ö,BGH-KH·ªêI QU·∫¢N L√ù\n01/12/2025,Th·ª© 2,07:30 SA,Ch√†o c·ªù,S√¢n tr∆∞·ªùng,TPT,To√†n tr∆∞·ªùng,,TH`;

const TAG_COLOR_MAP = { "BGH": "tag-bgh" };
const TAG_REGEX = new RegExp(`\\b(${Object.keys(TAG_COLOR_MAP).join('|')})\\b`, 'g');

const App = {
    currentFilterDay: 'all', 
    CACHE_KEY: 'instant_schedule_data_v9',
    HASH_KEY: 'instant_schedule_hash_v9',
    deferredPrompt: null,

    init() {
        document.addEventListener('DOMContentLoaded', () => {
            this.renderFixedFilterButtons();
            this.autoSelectCurrentDay(); 
            this.registerServiceWorker();
            this.loadFromCache();
            this.loadScheduleData(false);
            this.initRealtimeCheck(); 
            this.setupInstallButton();
        });
    },

    renderFixedFilterButtons() {
        const standardDays = ['Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7', 'Ch·ªß Nh·∫≠t'];
        let html = `<button class="filter-btn" data-day="all" onclick="App.setDayFilter('all', this)">T·∫•t c·∫£</button>`;
        standardDays.forEach(day => {
            html += `<button class="filter-btn" data-day="${day}" onclick="App.setDayFilter('${day}', this)">${day}</button>`;
        });
        document.getElementById('day-filters').innerHTML = html;
        document.getElementById('day-filters').style.display = 'flex';
    },

    autoSelectCurrentDay() {
        const mapDay = ['Ch·ªß Nh·∫≠t', 'Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7'];
        const todayIndex = new Date().getDay(); 
        const todayLabel = mapDay[todayIndex];
        const btn = document.querySelector(`.filter-btn[data-day="${todayLabel}"]`);
        if (btn) {
            this.setDayFilter(todayLabel, btn);
        } else {
            const allBtn = document.querySelector(`.filter-btn[data-day="all"]`);
            if(allBtn) this.setDayFilter('all', allBtn);
        }
    },

    registerServiceWorker() {
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').catch(console.log);
    },

    setupInstallButton() {
        const installBtn = document.getElementById('install-app-btn');
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); this.deferredPrompt = e; installBtn.style.display = 'inline-block';
        });
        installBtn.addEventListener('click', () => {
            installBtn.style.display = 'none'; this.deferredPrompt.prompt();
            this.deferredPrompt.userChoice.then((res) => { this.deferredPrompt = null; });
        });
    },

    parseCSV(text) {
        const rows = []; let currentRow = []; let currentVal = ''; let inQuote = false;
        for (let i = 0; i < text.length; i++) {
            const char = text[i], nextChar = text[i + 1];
            if (char === '"') { inQuote ? (nextChar === '"' ? (currentVal += '"', i++) : inQuote = !inQuote) : inQuote = !inQuote; } 
            else if (char === ',' && !inQuote) { currentRow.push(currentVal); currentVal = ''; } 
            else if ((char === '\r' || char === '\n') && !inQuote) { if (char === '\r' && nextChar === '\n') i++; currentRow.push(currentVal); rows.push(currentRow); currentRow = []; currentVal = ''; } else { currentVal += char; }
        }
        if (currentRow.length > 0 || currentVal !== '') { currentRow.push(currentVal); rows.push(currentRow); }
        return rows;
    },

    filterTable() {
        const table = document.querySelector("table.custom-schedule");
        if (!table) return;
        const rows = table.querySelector("tbody").getElementsByTagName("tr");
        const filterKey = this.currentFilterDay.toLowerCase().trim();

        for (const row of rows) {
            const rowDayRaw = (row.getAttribute('data-day') || '').toLowerCase().trim();
            let isMatch = false;
            if (this.currentFilterDay === 'all') { isMatch = true; } 
            else {
                if (rowDayRaw.includes(filterKey)) isMatch = true;
                else {
                    const digit = filterKey.match(/\d+/); 
                    if (digit && rowDayRaw.includes(digit[0])) isMatch = true;
                    if (filterKey.includes('ch·ªß nh·∫≠t') && (rowDayRaw.includes('cn') || rowDayRaw.includes('nh·∫≠t'))) isMatch = true;
                }
            }
            row.style.display = isMatch ? "" : "none";
        }
    },

    setDayFilter(day, btnElement) {
        this.currentFilterDay = day;
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        if(btnElement) btnElement.classList.add('active');
        this.filterTable();
    },
    
    scrollToToday() {
        this.autoSelectCurrentDay();
        setTimeout(() => {
            const todayRow = document.querySelector('tr.is-today');
            if(todayRow) {
                todayRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                todayRow.style.transition = 'background-color 0.5s';
                const originalBg = todayRow.style.backgroundColor;
                todayRow.style.backgroundColor = '#86e49d';
                setTimeout(() => { todayRow.style.backgroundColor = originalBg; }, 1000);
            }
        }, 100);
    },

    loadFromCache() {
        const cached = localStorage.getItem(this.CACHE_KEY);
        if (cached) this.renderProfessionalTable(cached, false);
    },

    loadScheduleData(isBackground = false) {
        const noCacheUrl = SCRIPT_URL + (SCRIPT_URL.includes('?') ? '&' : '?') + 'nocache=' + new Date().getTime();
        fetch(noCacheUrl, { method: 'GET' })
            .then(res => res.text())
            .then(csv => {
                if (!csv || csv.includes("Error") || csv.length < 50) return;
                if(isBackground) { this.checkAndAutoUpdate(csv); } else { this.processNewData(csv); }
            })
            .catch(err => {
                if(!isBackground && !localStorage.getItem(this.CACHE_KEY)) this.renderProfessionalTable(FALLBACK_DATA, true);
            });
    },

    processNewData(newCsv) {
        localStorage.setItem(this.CACHE_KEY, newCsv);
        localStorage.setItem(this.HASH_KEY, newCsv.length);
        this.renderProfessionalTable(newCsv);
    },

    checkAndAutoUpdate(newCsv) {
        const oldHash = localStorage.getItem(this.HASH_KEY);
        if (oldHash && parseInt(oldHash) !== newCsv.length) {
            this.processNewData(newCsv); 
            const toast = document.getElementById("toast-notify");
            if (toast) { toast.classList.add("show"); setTimeout(() => toast.classList.remove("show"), 3000); }
        }
    },

    initRealtimeCheck() { setInterval(() => { this.loadScheduleData(true); }, 15000); },

    getTodayString() {
        const today = new Date();
        const d = today.getDate();
        const m = today.getMonth() + 1;
        return [`${d < 10 ? '0' + d : d}/${m < 10 ? '0' + m : m}`, `${d}/${m < 10 ? '0' + m : m}`];
    },

    getFullDateDisplay() {
        const date = new Date();
        const dayNames = ['Ch·ªß Nh·∫≠t', 'Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7'];
        const dayName = dayNames[date.getDay()];
        const d = date.getDate();
        const m = date.getMonth() + 1;
        const y = date.getFullYear();
        return `${dayName} - ${d}/${m}/${y}`;
    },

    renderProfessionalTable(csvText, isDemo = false) {
        try {
            const rawData = this.parseCSV(csvText);
            const headerRowIndex = rawData.findIndex(row => row.some(c => c && c.toLowerCase().includes('th·ª©'))) || 0;
            const headers = rawData[headerRowIndex];
            const bodyRows = rawData.slice(headerRowIndex + 1).filter(r => !r.every(c => c.trim() === ''));
            
            if (!isDemo && headerRowIndex > 0) {
                const info = rawData[0].filter(c => c).join(' - ');
                if(info) document.getElementById('top-info').innerHTML = `<h2>${info}</h2>`;
            }

            const todayFormats = this.getTodayString(); 
            const bghCount = bodyRows.filter(r => r.join(' ').toUpperCase().includes('BGH')).length;
            
            const fullDateStr = this.getFullDateDisplay();

            const dashboardTarget = document.getElementById('ai-dashboard');
            dashboardTarget.innerHTML = `
                <div class="stat-card">S·ª± ki·ªán: <span class="stat-num">${bodyRows.length}</span></div>
                <div class="stat-card">L·ªãch BGH: <span class="stat-num">${bghCount}</span></div>
                <div class="stat-card clickable" onclick="App.scrollToToday()" title="B·∫•m ƒë·ªÉ xem l·ªãch h√¥m nay">
                    H√¥m nay: <span class="stat-date">${fullDateStr}</span>
                </div>
            `;
            dashboardTarget.style.display = "flex";

            const spanMap = this.calculateRowSpans(bodyRows, headers);
            let bodyHtml = '';
            
            const idxTime = headers.findIndex(c => c.toLowerCase().includes('th·ªùi gian'));
            const idxChuTri = headers.findIndex(c => c.toLowerCase().includes('ch·ªß tr√¨'));
            // --- TH√äM: T√¨m c·ªôt Th√†nh Ph·∫ßn ---
            const idxThanhPhan = headers.findIndex(c => c.toLowerCase().includes('th√†nh ph·∫ßn'));
            const idxThu = headers.findIndex(c => c.toLowerCase().includes('th·ª©'));
            const idxNgay = headers.findIndex(c => c.toLowerCase().includes('ng√†y'));

            let lastSeenDate = '';
            let lastSeenDay = '';

            const headerHtml = headers.map((h, i) => {
                let displayStyle = (h.trim() === '') ? 'display: none;' : '';
                let extraClass = '';
                if (i === idxNgay) extraClass += ' col-sticky-date'; 
                if (i === idxThu) extraClass += ' col-thu';
                if (i === idxTime) extraClass += ' col-time';
                return `<th class="${extraClass}" style="${displayStyle}">${h}</th>`;
            }).join('');

            bodyRows.forEach((row, rIdx) => {
                let dayText = (idxThu > -1 ? row[idxThu] : '').trim();
                let dateText = (idxNgay > -1 ? row[idxNgay] : '').trim();
                if (dateText) lastSeenDate = dateText;
                if (dayText) lastSeenDay = dayText; 
                
                let isToday = false;
                if (lastSeenDate) isToday = todayFormats.some(fmt => lastSeenDate.includes(fmt));
                const rowClass = isToday ? 'is-today' : '';

                bodyHtml += `<tr data-day="${lastSeenDay}" data-date="${lastSeenDate}" class="${rowClass}">`;
                
                headers.forEach((h, c) => {
                    let displayStyle = (h.trim() === '') ? 'display: none;' : '';
                    if (spanMap[rIdx] && spanMap[rIdx][c] === 0) return;
                    let content = row[c] || '';
                    
                    // --- LOGIC M·ªöI: √Åp d·ª•ng Tag BGH cho c·∫£ Ch·ªß tr√¨ V√Ä Th√†nh ph·∫ßn ---
                    if(c === idxChuTri || c === idxThanhPhan) {
                        content = content.replace(TAG_REGEX, m => `<span class="${TAG_COLOR_MAP[m]}">${m}</span>`);
                    } else if (content === 'BGH') {
                        content = `<span class="tag-bgh">${content}</span>`;
                    }
                    
                    let cls = (c === idxNgay) ? 'col-sticky-date' : (c === idxTime ? 'col-time' : '');
                    if (c === idxThu) cls += ' col-thu';
                    if (c === idxChuTri) cls += ' align-center';
                    let rowspan = (spanMap[rIdx][c] > 1) ? ` rowspan="${spanMap[rIdx][c]}"` : '';
                    
                    bodyHtml += `<td class="${cls}"${rowspan} style="${displayStyle}">${content.replace(/\n/g, '<br>')}</td>`;
                });
                bodyHtml += `</tr>`;
            });

            document.getElementById('main-table').innerHTML = `<table class="custom-schedule"><thead><tr>${headerHtml}</tr></thead><tbody>${bodyHtml}</tbody></table>`;
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('main-table').style.display = 'block';
            
            const tableRows = document.querySelectorAll('table.custom-schedule tbody tr');
            tableRows.forEach(row => {
                row.addEventListener('click', function() {
                    tableRows.forEach(r => r.classList.remove('row-selected'));
                    this.classList.add('row-selected');
                });
            });

            this.filterTable();
            
            setTimeout(() => {
                const todayRow = document.querySelector('tr.is-today');
                if(todayRow) todayRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 500);

        } catch (e) { console.error(e); }
    },

    calculateRowSpans(bodyRows, headers) {
        if (!bodyRows.length) return [];
        const idxNgay = headers.findIndex(c => c.toLowerCase().includes('ng√†y'));
        const idxThu = headers.findIndex(c => c.toLowerCase().includes('th·ª©'));
        const idxTime = headers.findIndex(c => c.toLowerCase().includes('th·ªùi gian'));
        const colsToMerge = [idxNgay, idxThu, idxTime].filter(i => i !== -1);
        const spanMap = bodyRows.map(() => Array(headers.length).fill(1));
        let start = 0;
        for (let i = 1; i < bodyRows.length; i++) {
            const match = colsToMerge.every(c => (bodyRows[i][c]||'').trim() === (bodyRows[i-1][c]||'').trim() && (bodyRows[i][c]||''));
            if (match) { colsToMerge.forEach(c => { spanMap[i][c] = 0; spanMap[start][c]++; }); } else { start = i; }
        }
        return spanMap;
    }
};

App.init();
</script>
</body>
</html>

